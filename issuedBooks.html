<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Issued Books</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      margin: 0;
    }
    .sidebar {
      width: 220px;
      background-color: #fff;
      border-right: 1px solid #ddd;
      height: 100vh;
      padding-top: 20px;
    }
    .sidebar a {
      display: block;
      padding: 12px 20px;
      text-decoration: none;
      color: #333;
    }
    .sidebar a:hover {
      background-color: #f2f2f2;
    }
    .main {
      flex: 1;
      padding: 20px;
    }
    h2 {
      margin-top: 0;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f9f9f9;
    }
    form {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    form label {
      display: block;
      margin: 8px 0 4px;
    }
    form select, form input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    form button {
      padding: 8px 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    form button:hover {
      background-color: #45a049;
    }
    .delete-btn {
      padding: 5px 10px;
      background-color: #e74c3c;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .delete-btn:hover {
      background-color: #c0392b;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <a href="/dashboard">Dashboard</a>
    <a href="/books">Books</a>
    <a href="/users">Users</a>
    <a href="/issuedbooks" style="font-weight: bold;">Issued Books</a>
    <a href="/payments">Payments</a>
  </div>

  <div class="main">
    <h2>Issued Books</h2>

    <form id="issueForm">
      <h3>Issue New Book</h3>

      <!-- issue_id (optional; leave blank to auto-generate if your DB uses SERIAL) -->
      <label for="issueId">Issue ID (optional):</label>
      <input type="number" id="issueId" placeholder="Leave blank to auto-generate" />

      <!-- title -->
      <label for="bookSelect">Title:</label>
      <select id="bookSelect" required></select>

      <!-- id (users) -->
      <label for="userIdSelect">User ID (users table):</label>
      <select id="userIdSelect" required></select>

      <!-- fullname (can be typed or auto-filled from selected user) -->
      <label for="fullnameInput">Full Name:</label>
      <input type="text" id="fullnameInput" placeholder="Full name" required />

      <!-- issue_date -->
      <label for="issueDate">Issue Date:</label>
      <input type="date" id="issueDate" required />

      <!-- due_date -->
      <label for="dueDate">Due Date:</label>
      <input type="date" id="dueDate" required />

      <button type="submit">Issue Book</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>Issue ID</th>
          <th>Title</th>
          <th>User ID</th>
          <th>Full Name</th>
          <th>Issue Date</th>
          <th>Due Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="issuedBooksTable">
        <!-- Data will load here -->
      </tbody>
    </table>
  </div>

  <script>
    // Load users and books for selects
    async function loadOptions() {
      const users = await fetch('/api/users').then(r => r.json());
      const books = await fetch('/api/books').then(r => r.json());

      // Books -> use title as the value since your issuedBooks table stores the title
      const bookSelect = document.getElementById('bookSelect');
      bookSelect.innerHTML = '';
      books.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.title;           // store title directly
        opt.textContent = b.title;
        bookSelect.appendChild(opt);
      });

      // Users -> value is user id; keep fullname in data attribute to auto-fill
      const userIdSelect = document.getElementById('userIdSelect');
      userIdSelect.innerHTML = '';
      users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;              // id column from users
        opt.textContent = `${u.id} - ${u.fullname}`;
        opt.dataset.fullname = u.fullname;
        userIdSelect.appendChild(opt);
      });

      // When user id changes, auto-fill fullname input
      userIdSelect.addEventListener('change', () => {
        const sel = userIdSelect.options[userIdSelect.selectedIndex];
        const name = sel ? sel.dataset.fullname : '';
        document.getElementById('fullnameInput').value = name || '';
      });

      // Initialize fullname from first user (if any)
      if (userIdSelect.options.length > 0) {
        const first = userIdSelect.options[0];
        document.getElementById('fullnameInput').value = first.dataset.fullname || '';
      }
    }

    // Set default issue_date to today
    function setDefaultIssueDate() {
      const issueDate = document.getElementById('issueDate');
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      issueDate.value = `${yyyy}-${mm}-${dd}`;
    }

    // Delete issued book
    async function deleteIssuedBook(issue_id) {
      if (!confirm('Are you sure you want to delete this record?')) return;

      const res = await fetch(`/api/issuedBooks/${issue_id}`, {
        method: 'DELETE'
      });

      if (res.ok) {
        alert('Record deleted successfully');
        loadIssuedBooks();
      } else {
        alert('Error deleting record');
      }
    }

    // Load issued books rows
    async function loadIssuedBooks() {
      const res = await fetch('/api/issuedBooks');
      const data = await res.json();
      const table = document.getElementById('issuedBooksTable');
      table.innerHTML = '';

      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.issue_id ?? ''}</td>
          <td>${item.title ?? ''}</td>
          <td>${item.id ?? ''}</td>
          <td>${item.fullname ?? ''}</td>
          <td>${item.issue_date ?? ''}</td>
          <td>${item.due_date ?? ''}</td>
          <td><button class="delete-btn" onclick="deleteIssuedBook(${item.issue_id})">Delete</button></td>
        `;
        table.appendChild(tr);
      });
    }

    // Handle form submit
    document.getElementById('issueForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const issue_id = document.getElementById('issueId').value.trim(); // optional
      const title = document.getElementById('bookSelect').value;
      const userIdSel = document.getElementById('userIdSelect');
      const id = userIdSel.value; // users.id
      const fullname = document.getElementById('fullnameInput').value.trim();
      const issue_date = document.getElementById('issueDate').value;
      const due_date = document.getElementById('dueDate').value;

      // Minimal validation (require title, id, fullname, dates)
      if (!title || !id || !fullname || !issue_date || !due_date) {
        alert('Please fill all required fields.');
        return;
      }

      const payload = {
        issue_id: issue_id || undefined, // optional
        title,
        id,
        fullname,
        issue_date,
        due_date
      };

      const res = await fetch('/api/issuedBooks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        alert('Book issued successfully!');
        document.getElementById('issueForm').reset();
        setDefaultIssueDate();
        loadIssuedBooks();
      } else {
        const err = await res.json().catch(() => ({}));
        alert(err.error || 'Error issuing book');
      }
    });

    // Init
    loadOptions();
    setDefaultIssueDate();
    loadIssuedBooks();
  </script>
</body>
</html>
